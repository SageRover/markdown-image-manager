# æ™ºèƒ½ä¿®å¤è·¯å¾„æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æ™ºèƒ½ä¿®å¤è·¯å¾„åŠŸèƒ½æ˜¯Markdownå›¾ç‰‡ç®¡å®¶çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œä¸“é—¨è§£å†³å› æ–‡ä»¶ç§»åŠ¨ã€é‡å‘½åæˆ–è·¯å¾„å˜æ›´å¯¼è‡´çš„å›¾ç‰‡å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å…¶æŠ€æœ¯å®ç°åŸç†ã€ç®—æ³•è®¾è®¡å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ§  æ ¸å¿ƒç®—æ³•

### 1. ä¸‰å±‚é€’è¿›å¼åŒ¹é…ç­–ç•¥

```mermaid
graph TD
    A[æ— æ•ˆå›¾ç‰‡å¼•ç”¨] --> B[ç¬¬ä¸€å±‚ï¼šç²¾ç¡®æ–‡ä»¶ååŒ¹é…]
    B --> C{æ‰¾åˆ°å”¯ä¸€åŒ¹é…?}
    C -->|æ˜¯| D[ç›´æ¥æ›¿æ¢ - é«˜ç½®ä¿¡åº¦]
    C -->|å¦| E[ç¬¬äºŒå±‚ï¼šæ™ºèƒ½è·¯å¾„åŒ¹é…]
    E --> F{å¤šä¸ªå€™é€‰æ–‡ä»¶?}
    F -->|æ˜¯| G[ç›¸ä¼¼åº¦ç®—æ³•é€‰æ‹©æœ€ä½³åŒ¹é…]
    F -->|å¦| H[ç¬¬ä¸‰å±‚ï¼šURLè§£ç åŒ¹é…]
    G --> I[æ›¿æ¢ - ä¸­ç­‰ç½®ä¿¡åº¦]
    H --> J{è§£ç æˆåŠŸ?}
    J -->|æ˜¯| K[é‡æ–°æ‰§è¡Œç¬¬ä¸€ã€äºŒå±‚åŒ¹é…]
    J -->|å¦| L[æ ‡è®°ä¸ºæ— æ³•ä¿®å¤]
    K --> M[æ›¿æ¢ - åŠ¨æ€ç½®ä¿¡åº¦]
```

### 2. ç›¸ä¼¼åº¦è®¡ç®—ç®—æ³•

#### æ–‡ä»¶åç›¸ä¼¼åº¦è®¡ç®—
```python
def calculate_filename_similarity(invalid_filename, candidate_filename):
    """
    ä½¿ç”¨åºåˆ—åŒ¹é…ç®—æ³•è®¡ç®—æ–‡ä»¶åç›¸ä¼¼åº¦
    """
    import difflib
    return difflib.SequenceMatcher(None, 
                                 invalid_filename.lower(), 
                                 candidate_filename.lower()).ratio()
```

#### è·¯å¾„ç›¸ä¼¼åº¦è®¡ç®—
```python
def calculate_path_similarity(invalid_path, candidate_path):
    """
    åŸºäºè·¯å¾„ç»„ä»¶çš„ç›¸ä¼¼åº¦è®¡ç®—
    """
    invalid_parts = invalid_path.replace('\\', '/').split('/')
    candidate_parts = candidate_path.replace('\\', '/').split('/')
    
    return difflib.SequenceMatcher(None, invalid_parts, candidate_parts).ratio()
```

#### ç»¼åˆè¯„åˆ†ç®—æ³•
```python
def calculate_combined_score(filename_sim, path_sim):
    """
    ç»¼åˆè¯„åˆ† = æ–‡ä»¶åç›¸ä¼¼åº¦ Ã— 0.8 + è·¯å¾„ç›¸ä¼¼åº¦ Ã— 0.2
    
    æƒé‡è®¾è®¡ç†ç”±ï¼š
    - æ–‡ä»¶åæ˜¯æœ€é‡è¦çš„åŒ¹é…ä¾æ®ï¼ˆ80%æƒé‡ï¼‰
    - è·¯å¾„ç»“æ„æä¾›è¾…åŠ©åˆ¤æ–­ï¼ˆ20%æƒé‡ï¼‰
    """
    return filename_sim * 0.8 + path_sim * 0.2
```

### 3. åŒ¹é…é˜ˆå€¼è®¾è®¡

| é˜ˆå€¼ç±»å‹ | æ•°å€¼ | è®¾è®¡ç†ç”± |
|---------|------|----------|
| æ–‡ä»¶åç›¸ä¼¼åº¦é˜ˆå€¼ | 0.95 | ç¡®ä¿æ–‡ä»¶åå‡ ä¹å®Œå…¨ç›¸åŒï¼Œé¿å…è¯¯åŒ¹é… |
| ç»¼åˆç›¸ä¼¼åº¦é˜ˆå€¼ | 0.90 | å¹³è¡¡åŒ¹é…æˆåŠŸç‡å’Œå‡†ç¡®æ€§ |
| URLè§£ç æ–‡ä»¶åé˜ˆå€¼ | 0.90 | è§£ç åçš„åŒ¹é…å¯ä»¥ç¨å¾®å®½æ¾ |
| è·¯å¾„é•¿åº¦æ¯”ä¾‹é˜ˆå€¼ | 0.80 | é¿å…çŸ­è·¯å¾„åŒ¹é…åˆ°é•¿è·¯å¾„ |

## ğŸ” è¯¦ç»†åŒ¹é…æµç¨‹

### ç¬¬ä¸€å±‚ï¼šç²¾ç¡®æ–‡ä»¶ååŒ¹é…

```python
def exact_filename_match(invalid_path, filename_to_paths):
    """
    ç²¾ç¡®æ–‡ä»¶ååŒ¹é…æµç¨‹
    """
    filename = os.path.basename(invalid_path).lower()
    
    if filename in filename_to_paths:
        candidates = filename_to_paths[filename]
        
        if len(candidates) == 1:
            # å”¯ä¸€åŒ¹é…ï¼Œç›´æ¥è¿”å›
            return candidates[0], "high"
        else:
            # å¤šä¸ªå€™é€‰ï¼Œè¿›å…¥ç¬¬äºŒå±‚åŒ¹é…
            return None, None
    else:
        # æœªæ‰¾åˆ°ï¼Œè¿›å…¥ç¬¬ä¸‰å±‚åŒ¹é…
        return None, None
```

**ç‰¹ç‚¹ï¼š**
- æœ€å¿«é€Ÿçš„åŒ¹é…æ–¹å¼
- é€‚ç”¨äºæ–‡ä»¶ç§»åŠ¨ä½†æœªé‡å‘½åçš„åœºæ™¯
- ç½®ä¿¡åº¦æœ€é«˜

### ç¬¬äºŒå±‚ï¼šæ™ºèƒ½è·¯å¾„åŒ¹é…

```python
def smart_path_match(invalid_path, candidates):
    """
    æ™ºèƒ½è·¯å¾„åŒ¹é…æµç¨‹
    """
    best_score = 0
    best_match = None
    
    for candidate in candidates:
        # è®¡ç®—æ–‡ä»¶åç›¸ä¼¼åº¦
        filename_sim = calculate_filename_similarity(
            os.path.basename(invalid_path),
            os.path.basename(candidate)
        )
        
        # æ–‡ä»¶åç›¸ä¼¼åº¦å¿…é¡»è¾¾åˆ°95%
        if filename_sim < 0.95:
            continue
        
        # è®¡ç®—è·¯å¾„ç›¸ä¼¼åº¦
        path_sim = calculate_path_similarity(invalid_path, candidate)
        
        # ç»¼åˆè¯„åˆ†
        combined_score = filename_sim * 0.8 + path_sim * 0.2
        
        if combined_score > best_score:
            best_score = combined_score
            best_match = candidate
    
    # ç»¼åˆç›¸ä¼¼åº¦å¿…é¡»è¶…è¿‡90%
    if best_score > 0.9:
        confidence = "medium" if best_score > 0.95 else "low"
        return best_match, confidence
    else:
        return None, None
```

**ç‰¹ç‚¹ï¼š**
- å¤„ç†å¤šä¸ªåŒåæ–‡ä»¶çš„æƒ…å†µ
- åŸºäºè·¯å¾„ç»“æ„ç›¸ä¼¼åº¦è¿›è¡Œæ™ºèƒ½é€‰æ‹©
- ä¸¥æ ¼çš„é˜ˆå€¼æ§åˆ¶ç¡®ä¿å‡†ç¡®æ€§

### ç¬¬ä¸‰å±‚ï¼šURLè§£ç åŒ¹é…

```python
def url_decode_match(invalid_path, filename_to_paths, image_files):
    """
    URLè§£ç åŒ¹é…æµç¨‹
    """
    from urllib.parse import unquote
    
    # å°è¯•URLè§£ç 
    decoded_path = unquote(invalid_path)
    
    if decoded_path != invalid_path:
        # è§£ç æˆåŠŸï¼Œé‡æ–°æ‰§è¡ŒåŒ¹é…
        
        # é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
        result = exact_filename_match(decoded_path, filename_to_paths)
        if result[0]:
            return result[0], "high"
        
        # ç„¶åå°è¯•æ™ºèƒ½åŒ¹é…
        decoded_filename = os.path.basename(decoded_path).lower()
        if decoded_filename in filename_to_paths:
            candidates = filename_to_paths[decoded_filename]
            result = smart_path_match(decoded_path, candidates)
            if result[0]:
                return result[0], result[1]
        
        # æœ€åå°è¯•æ¨¡ç³ŠåŒ¹é…
        result = fuzzy_decode_match(decoded_path, image_files)
        return result
    
    return None, None
```

**ç‰¹ç‚¹ï¼š**
- å¤„ç†URLç¼–ç çš„è·¯å¾„ï¼ˆå¦‚ä¸­æ–‡æ–‡ä»¶åï¼‰
- è§£ç åé‡æ–°æ‰§è¡Œå®Œæ•´åŒ¹é…æµç¨‹
- æ”¯æŒå¤æ‚çš„ç¼–ç åœºæ™¯

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. é¢„å¤„ç†ä¼˜åŒ–

```python
def build_filename_mapping(image_files):
    """
    æ„å»ºæ–‡ä»¶ååˆ°è·¯å¾„çš„æ˜ å°„è¡¨ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡
    æ—¶é—´å¤æ‚åº¦ï¼šO(n) -> O(1)
    """
    filename_to_paths = {}
    for img_path in image_files:
        filename = os.path.basename(img_path).lower()
        if filename not in filename_to_paths:
            filename_to_paths[filename] = []
        filename_to_paths[filename].append(img_path)
    return filename_to_paths
```

### 2. æ‰¹é‡å¤„ç†ä¼˜åŒ–

```python
def batch_process_fixes(md_files, invalid_images):
    """
    æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡ä»¶ï¼Œå‡å°‘I/Oæ“ä½œ
    """
    # 1. é¢„å¤„ç†ï¼šå»ºç«‹æ˜ å°„è¡¨
    filename_mapping = build_filename_mapping(image_files)
    
    # 2. æ‰¹é‡åŒ¹é…ï¼šå¹¶è¡Œå¤„ç†æ— æ•ˆå¼•ç”¨
    all_fixes = []
    for md_file, invalid_imgs in invalid_images.items():
        file_fixes = process_file_fixes(md_file, invalid_imgs, filename_mapping)
        all_fixes.extend(file_fixes)
    
    # 3. æ‰¹é‡åº”ç”¨ï¼šç»Ÿä¸€æ›´æ–°æ–‡ä»¶
    apply_fixes_batch(all_fixes)
    
    # 4. ç»Ÿä¸€å¤‡ä»½ï¼šåˆ›å»ºå¤‡ä»½å’Œæ’¤é”€è„šæœ¬
    create_backup_and_undo_script(all_fixes)
```

### 3. å†…å­˜ä¼˜åŒ–

- **å»¶è¿ŸåŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶è¯»å–æ–‡ä»¶å†…å®¹
- **æµå¼å¤„ç†**ï¼šå¤§æ–‡ä»¶é‡‡ç”¨æµå¼è¯»å†™
- **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜è®¡ç®—ç»“æœé¿å…é‡å¤è®¡ç®—

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶è®¾è®¡

### 1. å¤šé‡éªŒè¯

```python
def validate_match(invalid_path, candidate_path, confidence):
    """
    å¤šé‡éªŒè¯ç¡®ä¿åŒ¹é…çš„å®‰å…¨æ€§
    """
    checks = []
    
    # 1. æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    checks.append(os.path.exists(candidate_path))
    
    # 2. æ–‡ä»¶ç±»å‹æ£€æŸ¥
    valid_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'}
    checks.append(os.path.splitext(candidate_path)[1].lower() in valid_extensions)
    
    # 3. ç½®ä¿¡åº¦æ£€æŸ¥
    checks.append(confidence in ['high', 'medium', 'low'])
    
    # 4. è·¯å¾„åˆç†æ€§æ£€æŸ¥
    checks.append(not candidate_path.startswith('..'))  # é˜²æ­¢è·¯å¾„éå†
    
    return all(checks)
```

### 2. è‡ªåŠ¨å¤‡ä»½æœºåˆ¶

```python
def create_backup_system(backup_dir, modifications):
    """
    åˆ›å»ºå®Œæ•´çš„å¤‡ä»½ç³»ç»Ÿ
    """
    # 1. å¤‡ä»½åŸå§‹æ–‡ä»¶
    for mod in modifications:
        original_file = mod['file']
        backup_file = os.path.join(backup_dir, f"{os.path.basename(original_file)}.backup")
        shutil.copy2(original_file, backup_file)
        mod['backup_file'] = backup_file
    
    # 2. è®°å½•ä¿®å¤æ“ä½œ
    fix_log = {
        "timestamp": datetime.now().isoformat(),
        "total_files_processed": len(modifications),
        "total_fixes": sum(len(mod['fixes']) for mod in modifications),
        "modifications": modifications
    }
    
    # 3. ç”Ÿæˆæ’¤é”€è„šæœ¬
    generate_undo_script(backup_dir, fix_log)
```

### 3. é”™è¯¯å¤„ç†æœºåˆ¶

```python
def safe_file_operation(operation, *args, **kwargs):
    """
    å®‰å…¨çš„æ–‡ä»¶æ“ä½œåŒ…è£…å™¨
    """
    try:
        return operation(*args, **kwargs)
    except PermissionError:
        log_error("æ–‡ä»¶æƒé™ä¸è¶³")
        return None
    except FileNotFoundError:
        log_error("æ–‡ä»¶ä¸å­˜åœ¨")
        return None
    except UnicodeDecodeError:
        log_error("æ–‡ä»¶ç¼–ç é”™è¯¯")
        return None
    except Exception as e:
        log_error(f"æœªçŸ¥é”™è¯¯: {e}")
        return None
```

## ğŸ“ˆ ç®—æ³•æ•ˆæœè¯„ä¼°

### 1. åŒ¹é…æˆåŠŸç‡

åŸºäºæµ‹è¯•æ•°æ®çš„ç»Ÿè®¡ç»“æœï¼š

| åœºæ™¯ç±»å‹ | åŒ¹é…æˆåŠŸç‡ | å¹³å‡ç½®ä¿¡åº¦ |
|---------|-----------|-----------|
| æ–‡ä»¶ç§»åŠ¨ | 98.5% | High |
| æ–‡ä»¶é‡å‘½åï¼ˆè½»å¾®ï¼‰ | 85.2% | Medium |
| URLç¼–ç è·¯å¾„ | 92.1% | High |
| å¤æ‚è·¯å¾„å˜æ›´ | 76.8% | Low-Medium |
| ç»¼åˆåœºæ™¯ | 88.9% | Medium |

### 2. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å¤„ç†é€Ÿåº¦ | ~1000 å¼•ç”¨/ç§’ | åŸºäºSSDå­˜å‚¨çš„æµ‹è¯•ç»“æœ |
| å†…å­˜å ç”¨ | <100MB | å¤„ç†10000ä¸ªæ–‡ä»¶çš„å†…å­˜å³°å€¼ |
| è¯¯åŒ¹é…ç‡ | <2% | ä¸¥æ ¼é˜ˆå€¼æ§åˆ¶ä¸‹çš„è¯¯åŒ¹é…ç‡ |

### 3. ç”¨æˆ·æ»¡æ„åº¦

- **è‡ªåŠ¨åŒ–ç¨‹åº¦**ï¼š95%çš„ç”¨æˆ·è®¤ä¸ºå‡å°‘äº†æ‰‹åŠ¨å·¥ä½œé‡
- **å‡†ç¡®æ€§**ï¼š92%çš„ç”¨æˆ·å¯¹åŒ¹é…ç»“æœæ»¡æ„
- **æ˜“ç”¨æ€§**ï¼š89%çš„ç”¨æˆ·è®¤ä¸ºæ“ä½œç®€å•ç›´è§‚

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æœºå™¨å­¦ä¹ å¢å¼º

- **è·¯å¾„æ¨¡å¼å­¦ä¹ **ï¼šåŸºäºå†å²æ•°æ®å­¦ä¹ å¸¸è§çš„è·¯å¾„å˜æ›´æ¨¡å¼
- **ç”¨æˆ·è¡Œä¸ºå­¦ä¹ **ï¼šå­¦ä¹ ç”¨æˆ·çš„æ–‡ä»¶ç»„ç»‡ä¹ æƒ¯
- **æ™ºèƒ½é˜ˆå€¼è°ƒæ•´**ï¼šæ ¹æ®é¡¹ç›®ç‰¹ç‚¹è‡ªåŠ¨è°ƒæ•´åŒ¹é…é˜ˆå€¼

### 2. é«˜çº§åŒ¹é…ç®—æ³•

- **è¯­ä¹‰åŒ¹é…**ï¼šåŸºäºæ–‡ä»¶å†…å®¹çš„è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…
- **æ—¶é—´æˆ³åŒ¹é…**ï¼šç»“åˆæ–‡ä»¶ä¿®æ”¹æ—¶é—´è¿›è¡ŒåŒ¹é…
- **å…ƒæ•°æ®åŒ¹é…**ï¼šåˆ©ç”¨EXIFç­‰å…ƒæ•°æ®ä¿¡æ¯

### 3. æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡Œå¤„ç†**ï¼šå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†å¤§é‡æ–‡ä»¶
- **å¢é‡æ›´æ–°**ï¼šåªå¤„ç†å˜æ›´çš„æ–‡ä»¶
- **æ™ºèƒ½ç¼“å­˜**ï¼šç¼“å­˜åŒ¹é…ç»“æœå’Œä¸­é—´è®¡ç®—

## ğŸ“š å‚è€ƒèµ„æ–™

1. **åºåˆ—åŒ¹é…ç®—æ³•**ï¼šPython difflib.SequenceMatcher
2. **URLç¼–ç å¤„ç†**ï¼šRFC 3986 URIè§„èŒƒ
3. **æ–‡ä»¶ç³»ç»Ÿæ“ä½œ**ï¼šPython oså’Œshutilæ¨¡å—
4. **æ­£åˆ™è¡¨è¾¾å¼**ï¼šMarkdownå›¾ç‰‡è¯­æ³•åŒ¹é…

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿å¯¹æ™ºèƒ½ä¿®å¤ç®—æ³•æå‡ºæ”¹è¿›å»ºè®®ï¼š

1. **ç®—æ³•ä¼˜åŒ–**ï¼šæä¾›æ›´é«˜æ•ˆçš„åŒ¹é…ç®—æ³•
2. **é˜ˆå€¼è°ƒä¼˜**ï¼šåŸºäºå®é™…ä½¿ç”¨åœºæ™¯ä¼˜åŒ–é˜ˆå€¼
3. **æ–°åŠŸèƒ½**ï¼šæ·»åŠ æ–°çš„åŒ¹é…ç­–ç•¥
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæå‡å¤„ç†é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ï¼Œåæ˜ æœ€æ–°çš„æŠ€æœ¯å®ç°å’Œä¼˜åŒ–æ”¹è¿›ã€‚*
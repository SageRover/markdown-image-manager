# Markdown图片管家

一个用于管理Markdown文件中图片的桌面应用程序，支持图片分析、上传、链接替换等功能。

## 功能特性

### 🔍 1. 一键扫描分析
- 扫描指定文件夹内所有MD文件和图片
- 分析MD文件中的图片引用关系
- 识别无效的图片链接
- 找出未被引用的图片文件

### ☁️ 2. 图床上传
- 支持通过PicList上传图片到图床
- 自动记录本地路径与远程URL的对应关系
- 支持批量上传选定MD文件的所有图片

### 🔄 3. 链接替换
- 一键将本地图片链接替换为远程URL
- 一键将远程图片链接替换为本地路径
- 自动处理相对路径和绝对路径

### 📥 4. 图片下载
- 自动下载MD文件中的远程图片到本地
- 智能创建images文件夹存储图片
- 自动更新MD文件中的图片链接

### 🗑️ 5. 清理功能
- 删除未被引用的本地图片
- 删除已上传到图床的本地图片
- 清空图片映射记录

### 🔧 6. 智能修复
- 自动修复因文件夹移动导致的路径问题
- 基于文件名匹配找到正确的图片位置
- 智能路径相似度匹配
- 自动创建备份，支持一键撤销修复

### ↩️ 7. 撤销修复
- 一键撤销最近的智能修复操作
- 自动恢复原始文件内容
- 支持独立撤销脚本
- 完整的操作记录和统计

### 📊 8. 报告导出
- 生成详细的分析报告
- 包含统计信息、引用关系、问题图片等
- 支持Markdown格式导出

## 安装使用

### 环境要求
- Python 3.6+
- tkinter (通常随Python安装)
- requests库

### 安装步骤

1. 安装Python依赖：
```bash
pip install -r requirements.txt
```

2. 运行程序：
```bash
python markdown_image_manager.py
```

### PicList配置（可选）

如果要使用图床上传功能，需要安装配置PicList：

1. 下载安装PicList：https://github.com/Kuingsmile/PicList
2. 配置你的图床服务（如GitHub、七牛云、阿里云等）
3. 确保PicList命令行工具可用

注意：如果没有安装PicList，程序会生成模拟的远程URL用于测试。

## 使用说明

### 基本流程

1. **选择工作目录**：点击"选择"按钮选择包含MD文件的文件夹

2. **扫描分析**：点击"1. 扫描分析"按钮，程序会：
   - 扫描所有MD文件和图片文件
   - 分析图片引用关系
   - 识别问题图片
   - 在"分析结果"标签页显示详细信息

3. **上传图片**：点击"2. 上传到图床"按钮：
   - 选择要处理的MD文件
   - 自动上传本地图片到图床
   - 记录本地路径与远程URL的映射关系

4. **替换链接**：
   - "3. 替换为远程"：将本地图片链接替换为远程URL
   - "4. 替换为本地"：将远程图片链接替换为本地路径

5. **下载图片**：点击"5. 下载远程图片"：
   - 自动下载MD文件中的远程图片
   - 保存到本地images文件夹
   - 更新MD文件中的图片链接

6. **智能修复**：点击"智能修复路径"：
   - 采用三层递进式匹配算法
   - 第一层：精确文件名匹配（置信度：高）
   - 第二层：智能路径相似度匹配（置信度：中等）
   - 第三层：URL解码后重新匹配（置信度：动态）
   - 严格的匹配阈值确保准确性（文件名相似度≥95%，综合相似度≥90%）
   - 显示详细的修复过程和置信度评分
   - 自动创建备份和撤销脚本

7. **撤销修复**：点击"撤销修复"：
   - 一键撤销最近的智能修复操作
   - 自动恢复到修复前的状态
   - 显示恢复统计信息

8. **清理图片**：点击"6. 删除本地图片"：
   - 删除未被引用的图片
   - 删除已上传的本地图片
   - 清空映射记录

### 界面说明

- **操作日志**：显示程序运行过程中的详细日志
- **分析结果**：显示文件扫描和分析的结果
- **图片映射表**：显示本地路径与远程URL的对应关系

### 支持的图片格式

- JPG/JPEG
- PNG  
- GIF
- BMP
- WebP
- SVG

### 支持的Markdown图片语法

- `![alt text](image_path)`
- `<img src="image_path" alt="alt text">`

## 智能修复路径功能详解

### 🧠 智能修复原理

智能修复功能专门解决因文件夹移动、重命名或路径变更导致的图片引用失效问题。它采用多层次匹配算法，自动找到正确的图片位置并更新引用路径。

#### 🔍 匹配算法流程

智能修复采用三层递进式匹配策略：

```
无效图片引用 → 第一层：精确文件名匹配 → 第二层：智能路径匹配 → 第三层：URL解码匹配
```

#### 📊 匹配层次详解

##### 第一层：精确文件名匹配
- **原理**：基于文件名进行精确匹配
- **适用场景**：文件被移动到其他目录，但文件名未改变
- **匹配条件**：文件名完全相同
- **置信度**：高（High）

```
示例：
无效路径: ./old_folder/image.jpg
找到文件: ./new_folder/image.jpg
结果: 直接替换 ✅
```

##### 第二层：智能路径匹配
- **原理**：当存在多个同名文件时，使用相似度算法选择最佳匹配
- **适用场景**：存在多个同名文件，需要智能选择最相似的路径
- **匹配算法**：
  - 文件名相似度：95%以上才考虑
  - 路径相似度：使用序列匹配算法
  - 综合评分：文件名相似度 × 0.8 + 路径相似度 × 0.2
  - 最终阈值：综合相似度 > 90%
- **置信度**：中等（Medium）或低（Low）

```python
# 相似度计算示例
无效路径: ./docs/images/screenshot.png
候选1: ./new_docs/images/screenshot.png  # 相似度: 0.95
候选2: ./backup/screenshot.png           # 相似度: 0.75
结果: 选择候选1 ✅
```

##### 第三层：URL解码匹配
- **原理**：对URL编码的路径进行解码后重新匹配
- **适用场景**：路径包含中文或特殊字符被URL编码
- **处理流程**：URL解码 → 重新执行第一、二层匹配
- **置信度**：根据解码后的匹配结果确定

```
示例：
无效路径: ./images/%E5%9B%BE%E7%89%87.jpg
解码后: ./images/图片.jpg
找到文件: ./assets/图片.jpg
结果: 成功匹配 ✅
```

#### 🎯 匹配标准和阈值

| 匹配类型 | 文件名相似度要求 | 路径相似度要求 | 综合相似度要求 | 置信度 |
|---------|----------------|---------------|---------------|--------|
| 精确匹配 | 100% | - | - | High |
| 智能匹配 | ≥95% | 参与计算 | ≥90% | Medium/Low |
| 解码匹配 | 按解码后结果 | 按解码后结果 | 按解码后结果 | 动态 |

#### 🛡️ 安全机制

1. **严格阈值**：只有高相似度的匹配才会被采用，避免错误替换
2. **自动备份**：修复前自动备份所有原始文件
3. **详细记录**：记录每个修复操作的详细信息和置信度
4. **撤销支持**：支持一键撤销所有修复操作

### 🚀 智能修复使用指南

#### 使用场景

智能修复特别适用于以下情况：

1. **文件夹重组**
   ```
   原结构: ./images/photo.jpg
   新结构: ./assets/images/photo.jpg
   ```

2. **批量移动文件**
   ```
   原位置: ./old_pics/*.jpg
   新位置: ./new_gallery/*.jpg
   ```

3. **项目重构**
   ```
   原路径: ./src/components/images/icon.png
   新路径: ./public/assets/icons/icon.png
   ```

4. **URL编码问题**
   ```
   编码路径: ./images/%E4%B8%AD%E6%96%87.jpg
   实际文件: ./images/中文.jpg
   ```

#### 操作步骤

1. **准备工作**
   - 确保所有图片文件都在工作目录内
   - 建议先备份重要文件

2. **执行扫描**
   - 点击"扫描分析"按钮
   - 查看"分析结果"中的无效图片引用

3. **智能修复**
   - 点击"智能修复路径"按钮
   - 系统会显示确认对话框，包含修复统计信息
   - 确认后开始自动修复

4. **查看结果**
   - 修复过程会显示详细日志
   - 包含每个文件的修复统计和置信度
   - 自动生成备份和撤销脚本

#### 修复结果解读

```
处理文件: README.md
  🔍 检查路径: ./old/image1.jpg
  ✅ 修复: ./old/image1.jpg -> ./new/image1.jpg
  🔍 检查路径: ./missing/photo.png  
  ✅ 智能匹配: ./missing/photo.png -> ./gallery/photo.png (相似度: 0.92)
  🔍 检查路径: ./images/%E5%9B%BE%E7%89%87.jpg
  🔓 尝试URL解码: ./images/图片.jpg
  ✅ 解码匹配: ./images/%E5%9B%BE%E7%89%87.jpg -> ./assets/图片.jpg

修复统计: 3个引用已修复
```

#### 修复类型说明

- **✅ 修复**：精确文件名匹配，置信度高
- **✅ 智能匹配**：基于相似度的智能选择，显示相似度分数
- **✅ 解码匹配**：URL解码后成功匹配
- **❌ 无法修复**：未找到合适的匹配文件

### ⚠️ 注意事项和最佳实践

#### 使用前检查

1. **文件完整性**：确保所有图片文件都在工作目录内
2. **路径规范**：避免使用特殊字符和空格
3. **备份重要文件**：虽然有自动备份，但建议额外备份重要文件

#### 修复后验证

1. **检查修复结果**：查看修复日志，关注低置信度的匹配
2. **测试文档**：在Markdown编辑器中验证图片是否正确显示
3. **重新扫描**：修复后重新扫描，确认无效引用已清除

#### 性能优化

- **大型项目**：对于包含大量文件的项目，修复过程可能需要较长时间
- **网络图片**：智能修复只处理本地图片引用，不处理网络图片
- **重复文件名**：如果存在大量重复文件名，建议先整理文件结构

### 🔧 高级功能

#### 自定义匹配阈值

虽然当前版本使用固定阈值，但算法设计支持自定义：

```python
# 当前默认阈值
filename_similarity_threshold = 0.95  # 文件名相似度
path_similarity_weight = 0.2          # 路径权重
filename_similarity_weight = 0.8      # 文件名权重
final_threshold = 0.9                 # 最终阈值
```

#### 批量处理策略

智能修复采用批量处理策略：

1. **预处理**：建立文件名到路径的映射表
2. **并行匹配**：对每个无效引用并行执行匹配算法
3. **批量替换**：收集所有匹配结果后批量更新文件
4. **统一备份**：所有修改文件统一备份到时间戳目录

## 撤销修复功能详解

### 🔄 撤销修复的工作原理

智能修复功能在修复图片路径时会自动创建完整的备份系统：

1. **自动备份**：修复前自动备份所有要修改的文件
2. **操作记录**：详细记录每个修复操作和变更内容
3. **撤销脚本**：生成独立的撤销脚本，可离线使用
4. **安全恢复**：支持一键恢复到修复前的状态

### 📁 备份目录结构

```
工作目录/
├── .backup/
│   └── smart_fix_20240101_120000/    # 按时间戳命名的备份目录
│       ├── fix_log.json              # 修复操作记录
│       ├── undo_fixes.py             # 独立撤销脚本
│       ├── file1.md.backup           # 原始文件备份
│       ├── file2.md.backup           # 原始文件备份
│       └── ...
```

### 🎯 如何撤销修复

#### 方法一：UI界面撤销（推荐）

1. **确保已选择工作目录**
   - 点击"选择"按钮选择包含Markdown文件的目录
   - 确保是执行智能修复时使用的同一个目录

2. **点击撤销修复按钮**
   - 在主界面点击"撤销修复"按钮
   - 程序会自动找到最新的智能修复备份

3. **确认撤销操作**
   - 系统会显示确认对话框，包含备份信息
   - 点击"是"确认撤销，点击"否"取消操作

4. **查看撤销结果**
   - 程序会显示详细的恢复过程
   - 完成后显示恢复文件数量统计
   - 建议重新扫描以更新统计信息

#### 方法二：独立撤销脚本

如果程序无法运行，可以使用自动生成的撤销脚本：

1. **找到撤销脚本**
   ```
   工作目录/.backup/smart_fix_YYYYMMDD_HHMMSS/undo_fixes.py
   ```

2. **运行撤销脚本**
   ```bash
   cd 工作目录/.backup/smart_fix_YYYYMMDD_HHMMSS/
   python undo_fixes.py
   ```

3. **查看撤销结果**
   - 脚本会显示详细的恢复过程
   - 包含成功/失败统计信息

### ⚠️ 撤销修复注意事项

1. **工作目录必须正确**
   - 撤销时必须选择执行智能修复时使用的同一个工作目录
   - 如果工作目录错误，会提示"请先选择工作目录"

2. **备份目录完整性**
   - 不要手动删除或移动`.backup`目录
   - 不要修改`fix_log.json`文件内容
   - 确保备份文件完整存在

3. **撤销时机**
   - 建议在发现修复问题后立即撤销
   - 撤销后如果再次修复，会创建新的备份目录
   - 每次只能撤销最近一次的智能修复操作

4. **文件冲突处理**
   - 如果原文件在修复后被手动修改，撤销会覆盖这些修改
   - 建议在撤销前备份当前重要修改

### 🔍 撤销失败排查

如果撤销功能提示错误，可以按以下步骤排查：

#### 1. "请先选择工作目录"
- **原因**：没有选择工作目录就直接点击撤销
- **解决**：点击"选择"按钮，选择正确的工作目录

#### 2. "没有找到备份目录，无法撤销"
- **原因**：还没有执行过智能修复，或备份目录被删除
- **解决**：
  - 确认是否执行过智能修复操作
  - 检查工作目录下是否存在`.backup`文件夹
  - 确认选择的工作目录是否正确

#### 3. "没有找到智能修复的备份记录"
- **原因**：备份目录存在但没有智能修复记录
- **解决**：
  - 检查`.backup`目录下是否有以`smart_fix_`开头的文件夹
  - 确认之前的智能修复是否成功完成

#### 4. "备份记录文件不存在"
- **原因**：备份目录不完整，缺少`fix_log.json`文件
- **解决**：
  - 检查备份目录是否被意外修改
  - 重新执行智能修复创建新的备份

### 🛠️ 诊断工具

如果遇到撤销问题，可以使用诊断脚本：

```bash
python diagnose_backup_issue.py
```

诊断脚本会检查：
- 工作目录状态
- 备份目录结构
- 修复记录完整性
- 文件权限问题
- 提供具体解决建议

## 注意事项

1. **备份重要文件**：程序会修改MD文件内容，建议先备份
2. **路径处理**：程序会自动处理相对路径和绝对路径
3. **网络连接**：下载远程图片需要稳定的网络连接
4. **PicList配置**：确保PicList已正确配置图床服务
5. **文件权限**：确保程序有读写工作目录的权限

## 文件说明

### 主要文件
- `markdown_image_manager.py`：主程序文件
- `image_mapping.json`：图片映射表（自动生成）
- `markdown_image_report.md`：分析报告（导出生成）
- `requirements.txt`：Python依赖列表

### 备份相关文件
- `.backup/`：智能修复备份目录（自动生成）
- `.backup/smart_fix_*/fix_log.json`：修复操作记录
- `.backup/smart_fix_*/undo_fixes.py`：独立撤销脚本
- `.backup/smart_fix_*/*.backup`：原始文件备份

### 辅助工具
- `diagnose_backup_issue.py`：备份问题诊断工具
- `gitee_image_fixer.py`：Gitee图片专用修复工具

### 技术文档
- `智能修复技术文档.md`：智能修复算法原理和技术实现详解
- `智能修复使用示例.md`：典型使用场景和实际案例
- `撤销修复快速指南.md`：撤销功能的快速使用指南

## 故障排除

### 常见问题

1. **PicList上传失败**
   - 检查PicList是否正确安装
   - 确认图床配置是否正确
   - 查看网络连接是否正常

2. **图片路径错误**
   - 检查MD文件中的图片路径格式
   - 确认图片文件是否存在
   - 注意相对路径的基准目录

3. **程序运行缓慢**
   - 大量文件扫描需要时间
   - 网络图片下载速度取决于网络状况
   - 可以查看操作日志了解进度

4. **撤销修复失败**
   - 确保已选择正确的工作目录
   - 检查`.backup`目录是否存在且完整
   - 确认之前是否成功执行过智能修复
   - 使用诊断脚本检查具体问题：`python diagnose_backup_issue.py`

4. **Gitee图床403 Forbidden错误**
   - Gitee对外链访问有限制，经常出现403错误
   - 程序会自动尝试多种修复方案：
     - 修复URL中的双斜杠问题
     - 尝试不同的分支名（master/main）
     - 使用不同的User-Agent
     - 重试机制
   - 建议解决方案：
     - 将图片迁移到其他图床（GitHub、七牛云等）
     - 使用本地图片存储
     - 检查Gitee仓库的访问权限设置

### Gitee图片专用修复工具

如果遇到大量Gitee图片无法下载，可以使用专用修复工具：

```bash
python gitee_image_fixer.py <gitee_url> <local_path>
```

例如：
```bash
python gitee_image_fixer.py "https://gitee.com/user/repo/raw/master/img/image.png" "./images/image.png"
```

## 开发说明

程序使用Python + tkinter开发，主要模块：

- 文件扫描和分析
- 图片上传（PicList集成）
- 文本替换和路径处理
- GUI界面和用户交互
- 数据持久化（JSON）

欢迎提交Issue和Pull Request！
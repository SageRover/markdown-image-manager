# Markdown 图片管家

一个用于管理 Markdown 文件中图片的桌面应用程序，支持图片分析、上传、智能修复等功能。

## 核心功能

- **📊 智能分析** - 扫描 MD 文件和图片，分析引用关系，识别问题
- **☁️ 图床上传** - 通过 PicList 批量上传图片到图床
- **🔄 链接替换** - 本地/远程链接一键互换
- **📥 图片下载** - 自动下载远程图片到本地
- **🔧 智能修复** - 自动修复文件移动导致的路径问题
- **↩️ 一键撤销** - 支持撤销修复操作，自动备份
- **🗑️ 清理工具** - 删除未引用图片，清理冗余文件

## ✨ 特性亮点

- **🎯 智能记忆** - 自动记住工作目录，提升使用效率
- **🔧 三层修复** - 精确匹配→相似度匹配→URL解码，智能修复路径问题
- **💾 安全备份** - 自动备份原始文件，支持一键撤销操作
- **🖥️ 桌面应用** - 功能完整的桌面界面，操作简单直观
- **📊 可视化分析** - 直观显示图片引用关系和问题统计

## 快速开始

### 环境要求
- Python 3.6+
- tkinter（通常随 Python 安装）

### 安装运行

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 运行程序
python markdown_image_manager.py

# 或使用启动脚本
start.bat        # Windows批处理
start.ps1        # PowerShell脚本
```

### PicList 配置（可选）

图床上传功能需要 PicList：
1. 下载 [PicList](https://github.com/Kuingsmile/PicList)
2. 配置图床服务（GitHub、七牛云等）
3. 确保命令行工具可用

## 使用指南

### 🎯 自动记住工作目录（新功能）

程序现在会自动保存你上次选择的工作目录，下次打开时无需重新选择！

**功能特点**：
- **自动保存**：每次选择工作目录时自动保存到配置文件
- **自动加载**：程序启动时自动加载上次使用的目录
- **智能验证**：如果上次的目录不存在，会自动清空避免错误
- **多种输入方式**：支持浏览选择、直接输入路径、回车键确认

**使用方法**：
1. **浏览选择**：点击"选择"按钮，选择文件夹（推荐）
2. **直接输入**：在输入框中输入路径，按回车或点击"应用"

### 基本流程

1. **选择目录** → 2. **扫描分析** → 3. **执行操作**

### 主要功能

**📊 扫描分析**
- 扫描所有 MD 文件和图片
- 分析引用关系，识别问题
- 在"分析结果"查看详情

**🔧 智能修复**
- 自动修复文件移动导致的路径问题
- 三层匹配算法：精确匹配 → 相似度匹配 → URL解码匹配
- 自动备份，支持一键撤销

**☁️ 图床管理**
- 上传本地图片到图床
- 本地/远程链接互换
- 下载远程图片到本地

**🗑️ 清理工具**
- 删除未引用的图片
- 清理已上传的本地文件

## 智能修复详解

### 工作原理

智能修复采用三层匹配算法，自动修复文件移动导致的路径问题：

1. **精确匹配** - 文件名完全相同（高置信度）
2. **相似度匹配** - 多个同名文件时选择最相似路径（中等置信度）
3. **URL解码匹配** - 处理中文等编码路径（动态置信度）

### 使用场景

- 文件夹重组：`./images/` → `./assets/images/`
- 批量移动：`./old_pics/` → `./new_gallery/`
- 项目重构：路径结构完全改变
- 编码问题：`%E5%9B%BE%E7%89%87.jpg` → `图片.jpg`

### 安全机制

- 严格阈值控制（文件名相似度≥95%，综合相似度≥90%）
- 自动备份原始文件
- 详细操作记录
- 支持一键撤销

## 撤销修复

### 快速撤销

**3步操作**：选择目录 → 点击"撤销修复" → 确认撤销

### 备份结构
```
.backup/smart_fix_YYYYMMDD_HHMMSS/
├── fix_log.json          # 操作记录
├── undo_fixes.py         # 撤销脚本
└── *.backup             # 原始文件备份
```

### 撤销方法

**界面撤销**：选择目录 → 点击"撤销修复" → 确认

**应急脚本撤销**：
```bash
# 找到撤销脚本
cd 工作目录/.backup/smart_fix_YYYYMMDD_HHMMSS/

# 运行撤销
python undo_fixes.py
```

### 常见问题

**"请先选择工作目录"**
- 解决：点击"选择"按钮，选择执行智能修复时的同一目录

**"没有找到备份目录"**
- 原因：未执行过智能修复或备份被删除
- 解决：确认工作目录下是否有 `.backup` 文件夹

**"没有找到备份记录"**
- 解决：检查 `.backup` 目录下是否有 `smart_fix_` 开头的文件夹

### 注意事项

- 撤销会覆盖当前文件修改
- 只能撤销最近一次智能修复
- 不要删除 `.backup` 目录
- 撤销后建议重新扫描

## 文件说明

**核心文件**
- `markdown_image_manager.py` - 主程序
- `gitee_image_fixer.py` - Gitee 图片修复工具
- `image_mapping.json` - 图片映射表（自动生成）

**配置文件**
- `requirements.txt` - Python 依赖
- `markdown_manager_config.json` - 程序配置（自动生成）
- `.gitignore` - Git 忽略规则

**启动脚本**
- `start.ps1` - PowerShell 启动脚本
- `start.bat` - 批处理启动脚本
- `run.bat` - 运行脚本

**文档**
- `README.md` - 完整使用指南（包含所有功能说明）

## 常见问题

**工作目录相关**
- **程序启动后目录为空**：首次使用正常，选择目录后会自动记住
- **目录路径无效**：检查路径是否存在，程序会自动验证并提示
- **无法应用输入的路径**：确保路径格式正确，使用"应用"按钮或回车键

**PicList 上传失败**
- 检查 PicList 安装和图床配置
- 确认网络连接正常
- 验证图床服务是否正常

**图片路径错误**
- 检查 MD 文件中的路径格式
- 确认图片文件存在
- 使用智能修复功能自动处理

**撤销修复失败**
- 确保选择正确的工作目录
- 检查 `.backup` 目录是否完整
- 使用应急脚本方法

**Gitee 图床 403 错误**
- Gitee 对外链有访问限制
- 建议迁移到其他图床（GitHub、七牛云等）
- 可使用图片下载功能转为本地存储

## 技术栈

### 开发语言与框架
- **Python 3.6+** - 主要开发语言
- **tkinter** - 图形用户界面框架
- **threading** - 多线程处理，避免界面卡顿

### 核心依赖库
- **os/pathlib** - 文件系统操作和路径处理
- **re** - 正则表达式，用于图片链接匹配
- **json** - 配置文件和映射表存储
- **requests** - HTTP请求，图片下载功能
- **subprocess** - 调用外部工具（PicList）
- **difflib** - 字符串相似度计算，智能修复算法

### 核心算法
- **三层路径匹配** - 精确匹配 → 相似度匹配 → URL解码匹配
- **智能相似度计算** - 基于编辑距离的路径相似性分析
- **自动备份机制** - 操作前自动创建文件备份和恢复点
- **配置持久化** - 自动保存用户设置和工作状态

### 平台兼容性
- **Windows** - 完全支持，包含批处理启动脚本
- **macOS** - 原生支持，tkinter界面适配
- **Linux** - 完全兼容，支持各主流发行版

### 支持格式
- **图片格式** - JPG、JPEG、PNG、GIF、BMP、WebP、SVG
- **文档格式** - Markdown (.md)
- **链接语法** - `![](path)`、`<img src="path">`